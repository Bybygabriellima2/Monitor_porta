<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeDoor Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --status-safe: #10b981;
            --status-danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container { width: 100%; max-width: 450px; }

        .card {
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        h2 { font-weight: 800; margin-bottom: 10px; font-size: 1.8rem; }
        p { color: var(--text-secondary); margin-bottom: 20px; }

        input {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 2px solid #334155; background: #0f172a; color: white;
            font-size: 1rem; margin-bottom: 15px; text-align: center; outline: none;
        }
        input:focus { border-color: var(--accent-blue); }

        button {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 10px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-outline { background-color: transparent; border: 2px solid var(--accent-blue); color: var(--accent-blue); }
        .btn-warning { background-color: #f59e0b; color: #1e1e1e; }

        .hidden { display: none; }

        /* UI do Monitor */
        .status-indicator {
            padding: 20px; border-radius: 20px; margin: 20px 0;
            font-size: 1.5rem; font-weight: 800; text-transform: uppercase;
            transition: all 0.3s ease;
        }
        .state-closed { border: 2px solid var(--status-safe); color: var(--status-safe); background: rgba(16, 185, 129, 0.1); }
        .state-open { 
            border: 2px solid var(--status-danger); color: var(--status-danger); 
            background: rgba(239, 68, 68, 0.1); animation: pulse 0.5s infinite; 
        }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }

        /* 츼rea da Foto e C칙mera */
        #camera-preview {
            width: 100%; height: 250px; background: #000; border-radius: 12px;
            object-fit: cover; margin-bottom: 10px; display: none; border: 2px solid #334155;
        }
        #intruder-photo {
            width: 100%; border-radius: 12px; margin-top: 15px; border: 2px solid var(--status-danger);
            display: none; animation: slideIn 0.5s ease;
        }
        
        /* Lista de Logs */
        .log-container { margin-top: 20px; text-align: left; }
        .log-header { font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid #334155; margin-bottom: 10px; padding-bottom: 5px; }
        .log-list { list-style: none; max-height: 150px; overflow-y: auto; }
        .log-item { border-bottom: 1px solid #334155; padding: 10px 0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .log-time { color: var(--text-secondary); font-family: monospace; font-size: 0.8rem; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="card" id="setup-screen">
            <h2>SafeDoor Pro</h2>
            <p>Sistema de Alarme com Foto</p>
            <input type="text" id="room-code" placeholder="Crie um c칩digo (ex: PORTA1)" autocomplete="off">
            <button class="btn-primary" onclick="startMode('sensor')">游닝 Modo Sensor (Na Porta)</button>
            <button class="btn-outline" onclick="startMode('monitor')">游댒 Modo Monitor (Visualizar)</button>
        </div>

        <div class="card hidden" id="sensor-screen">
            <h2 style="color: var(--accent-blue)">Sensor Ativo</h2>
            <p style="font-size: 0.9rem;">Mantenha esta tela ligada e vis칤vel.</p>
            
            <video id="camera-preview" autoplay playsinline muted></video>
            <canvas id="camera-canvas" style="display:none;"></canvas> <div style="background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                Status: <strong id="sensor-status" style="color: var(--status-safe)">PARADO</strong>
                <br>
                <span style="font-size: 0.8rem; color: var(--text-secondary)">Sensibilidade: <span id="accel-value">0.00</span></span>
            </div>

            <button class="btn-warning" onclick="enableSensors()">丘멆잺 Ativar C칙mera e Sensores</button>
        </div>

        <div class="card hidden" id="monitor-screen">
            <p>Monitorando: <strong id="display-room" style="color: white">...</strong></p>
            
            <div id="status-display" class="status-indicator state-closed">游 Fechado</div>
            
            <img id="intruder-photo" src="" alt="Foto do Intruso">
            
            <div class="log-container">
                <div class="log-header">Hist칩rico de Acesso</div>
                <ul id="log-list" class="log-list">
                    <li style="text-align: center; padding: 10px; color: #475569;">Sem registros recentes</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Configura칞칚o WebSocket refor칞ada para o Render
        const socket = io({ transports: ['websocket'], upgrade: false });
        
        let currentMode = '';
        let roomCode = '';
        let audioContext = null; // Contexto de 치udio para o alarme

        // Vari치veis do Sensor
        let lastX = 0, lastY = 0, lastZ = 0;
        const SENSITIVITY = 2.5; // Valor ideal para detectar abertura de porta
        let timeout = null;
        let videoStream = null;

        async function startMode(mode) {
            roomCode = document.getElementById('room-code').value.toUpperCase().trim();
            if (!roomCode) return alert("Por favor, defina um c칩digo para conectar os dispositivos!");

            currentMode = mode;
            document.getElementById('setup-screen').classList.add('hidden');
            socket.emit('join_room', roomCode);

            if (mode === 'sensor') {
                document.getElementById('sensor-screen').classList.remove('hidden');
                // Tenta manter a tela ligada (Wake Lock)
                await keepScreenAwake();
            } else {
                document.getElementById('monitor-screen').classList.remove('hidden');
                document.getElementById('display-room').innerText = roomCode;
                initMonitorLogic();
            }
        }

        // ==================================================
        // L칍GICA DO MONITOR (Quem v칡)
        // ==================================================
        function initMonitorLogic() {
            // Desbloqueia o 치udio no primeiro clique do usu치rio (exig칡ncia dos navegadores)
            document.body.addEventListener('click', () => {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }, { once: true });

            // 1. Recebe Status (Aberto/Fechado)
            socket.on('update_monitor', (data) => {
                const display = document.getElementById('status-display');
                if (data.status === 'ABERTA') {
                    display.innerText = "游뚿 PORTA ABERTA!";
                    display.className = "status-indicator state-open";
                    playAlarm(); // Toca Sirene
                    if(navigator.vibrate) navigator.vibrate([500, 200, 500]); // Vibra celular
                } else {
                    display.innerText = "游 FECHADO";
                    display.className = "status-indicator state-closed";
                }
            });

            // 2. Recebe Foto
            socket.on('update_photo', (base64Image) => {
                const img = document.getElementById('intruder-photo');
                img.src = base64Image;
                img.style.display = 'block';
            });

            // 3. Recebe Hist칩rico
            socket.on('history_data', renderLogs);
            socket.on('history_update', (log) => addLogItem(log));
        }

        // Fun칞칚o que gera o som de sirene via c칩digo (sem precisar de mp3)
        function playAlarm() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();

            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.type = 'sawtooth'; // Onda dente de serra (som agressivo)
            osc.frequency.setValueAtTime(880, audioContext.currentTime); // Nota L치
            osc.frequency.exponentialRampToValueAtTime(440, audioContext.currentTime + 0.5); // Cai o tom (Uoooow)

            osc.connect(gain);
            gain.connect(audioContext.destination);

            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
            osc.stop(audioContext.currentTime + 0.5);
        }

        // ==================================================
        // L칍GICA DO SENSOR (Quem fica na porta)
        // ==================================================
        
        // Ativa c칙mera e sensores com permiss칚o
        async function enableSensors() {
            await startCamera();
            requestPermissionIOS();
        }

        // Liga a c칙mera frontal
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                const video = document.getElementById('camera-preview');
                video.srcObject = videoStream;
                video.style.display = 'block';
                video.play();
            } catch (err) {
                alert("Erro ao acessar c칙mera: " + err.message + ". Verifique se deu permiss칚o.");
            }
        }

        // Captura o frame atual do v칤deo e converte em imagem
        function captureAndSendPhoto() {
            if (!videoStream) return;
            
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');

            // Reduz a resolu칞칚o pela metade para envio r치pido
            canvas.width = video.videoWidth / 2;
            canvas.height = video.videoHeight / 2;
            
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Converte para texto Base64 (JPG qualidade 50%)
            const dataUrl = canvas.toDataURL('image/jpeg', 0.5); 
            
            socket.emit('sensor_photo', { room: roomCode, image: dataUrl });
        }

        // Inicia leitura do aceler칪metro
        function initSensorLogic() {
            window.addEventListener('devicemotion', (event) => {
                const acc = event.accelerationIncludingGravity;
                if (!acc) return;

                const delta = Math.max(
                    Math.abs(acc.x - lastX),
                    Math.abs(acc.y - lastY),
                    Math.abs(acc.z - lastZ)
                );

                if (delta > SENSITIVITY) {
                    triggerOpenState(delta);
                }

                lastX = acc.x; lastY = acc.y; lastZ = acc.z;
            }, true);
        }

        // Dispara o evento de porta aberta
        function triggerOpenState(val) {
            const statusTxt = document.getElementById('sensor-status');
            
            // Se j치 estiver disparado (status 'ABERTA'), n칚o faz nada para n칚o floodar
            if (statusTxt.innerText === 'ABERTA') return; 

            // 1. Atualiza UI Local
            statusTxt.innerText = 'ABERTA';
            statusTxt.style.color = '#ef4444';
            document.getElementById('accel-value').innerText = val.toFixed(2);

            // 2. Envia alerta pro servidor
            socket.emit('sensor_data', { room: roomCode, status: 'ABERTA', val: val });
            
            // 3. Tira e envia a foto!
            captureAndSendPhoto();

            // 4. Reseta ap칩s 4 segundos
            if(timeout) clearTimeout(timeout);
            timeout = setTimeout(() => {
                socket.emit('sensor_data', { room: roomCode, status: 'FECHADA', val: 0 });
                statusTxt.innerText = 'PARADO';
                statusTxt.style.color = '#10b981';
            }, 4000);
        }

        // ==================================================
        // UTILIT츼RIOS
        // ==================================================
        function renderLogs(history) {
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            if (history.length === 0) {
                list.innerHTML = '<li style="text-align: center; padding: 10px; color: #475569;">Sem registros recentes</li>';
                return;
            }
            history.forEach(log => addLogItem(log, false));
        }

        function addLogItem(log, prepend = true) {
            // Limpa msg de "vazio"
            const list = document.getElementById('log-list');
            if(list.innerText.includes('Sem registros')) list.innerHTML = '';

            const li = document.createElement('li');
            li.className = 'log-item';
            li.innerHTML = `
                <span style="color: #ef4444; font-weight:bold; display:flex; align-items:center; gap:5px;">
                    丘멆잺 Abertura
                </span> 
                <span class="log-time">${log.time}</span>
            `;
            prepend ? list.insertBefore(li, list.firstChild) : list.appendChild(li);
        }

        // Wake Lock (Impede tela de desligar)
        async function keepScreenAwake() {
            try { 
                if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); 
                console.log("Wake Lock Ativado");
            } catch(e){ console.log("Wake Lock falhou ou sem bateria"); }
        }

        // Permiss칚o iOS 13+
        function requestPermissionIOS() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(r => {
                    if(r==='granted') { 
                        initSensorLogic(); 
                        alert("Aceler칪metro Ativado!"); 
                    } else { alert("Permiss칚o negada para sensores."); }
                }).catch(console.error);
            } else {
                // Android ou iOS antigo
                initSensorLogic();
                alert("Sensores iniciados (Android/PC)");
            }
        }
    </script>
</body>
</html>